<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>해드림</title>
        <link rel="icon" th:href="@{/img/haedream.ico}"/>
        <!-- css -->
        <link rel="stylesheet" th:href="@{/css/etc/reset.css}"/>
        <link rel="stylesheet" th:href="@{/css/loglist.css}"/>
        <!-- fontawesome -->
        <script src="https://kit.fontawesome.com/d5377ff581.js" crossorigin="anonymous"></script>
        <!-- google font -->
        <link rel="preconnect" href="https://fonts.googleapis.com"/>
        <link
            rel="preconnect"
            href="https://fonts.gstatic.com"
            crossorigin="crossorigin"/>
        <link
            href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@100..900&display=swap"
            rel="stylesheet"/>
        <!-- jQuery -->
        <script
            src="https://code.jquery.com/jquery-3.7.1.js"
            integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
            crossorigin="anonymous"></script>
        <!-- js -->
        <script th:src="@{/js/loglist.js}" defer="defer"></script>
    </head>

    <body>
        <header>
            <div class="con">
                <div class="logo">
                    <a href="#"><img src="../img/HaeLogo.png" alt="해드림로고"/></a>
                </div>
                <ul class="menu">
                    <li class="nowPage">
                        <a href="#">로그</a>
                    </li>
                    <li>
                        <a href="#">평가<i class="fa-solid fa-caret-down"></i>
                        </a>
                    </li>
                    <li>
                        <a href="#">분석</a>
                    </li>
                    <li>
                        <a href="#">username</a>
                    </li>
                    <li>
                        <button class="delete" type="button">
                            <i class="fa-solid fa-arrow-right-from-bracket"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </header>
        <div class="container">
            <div class="con">
                <ul class="logList">
                    <li th:each="log : ${logs}">
                        <p class="index">1.</p>
                        <div class="mid">
                            <div class="projectName" th:text="${log.projectName}">Test Project</div>
                            <span class="modelName" th:text="${log.modelName}">Test model</span>
                            <span class="logDate" th:text="${log.logDate}">(2024.03.24)</span>
                        </div>
                        <div class="del">
                            <button class="del-button" th:attr="data-logId=${log.id}">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </li>
                    <li th:each="log : ${logs}">
                        <p class="index">2.</p>
                        <div class="mid">
                            <div class="projectName" th:text="${log.projectName}">Test Project</div>
                            <span class="modelName" th:text="${log.modelName}">Test model</span>
                            <span class="logDate" th:text="${log.logDate}">(2024.03.24)</span>
                        </div>
                        <div class="del">
                            <button class="del-button" th:attr="data-logId=${log.id}">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </li>
                    <li th:each="log : ${logs}">
                        <p class="index">3.</p>
                        <div class="mid">
                            <div class="projectName" th:text="${log.projectName}">Test Project</div>
                            <span class="modelName" th:text="${log.modelName}">Test model</span>
                            <span class="logDate" th:text="${log.logDate}">(2024.03.24)</span>
                        </div>
                        <div class="del">
                            <button class="del-button" th:attr="data-logId=${log.id}">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </li>
                    <li th:each="log : ${logs}">
                        <p class="index">4.</p>
                        <div class="mid">
                            <div class="projectName" th:text="${log.projectName}">Test Project</div>
                            <span class="modelName" th:text="${log.modelName}">Test model</span>
                            <span class="logDate" th:text="${log.logDate}">(2024.03.24)</span>
                        </div>
                        <div class="del">
                            <button class="del-button" th:attr="data-logId=${log.id}">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </li>
                    <li th:each="log : ${logs}">
                        <p class="index">5.</p>
                        <div class="mid">
                            <div class="projectName" th:text="${log.projectName}">Test Project</div>
                            <span class="modelName" th:text="${log.modelName}">Test model</span>
                            <span class="logDate" th:text="${log.logDate}">(2024.03.24)</span>
                        </div>
                        <div class="del">
                            <button class="del-button" th:attr="data-logId=${log.id}">
                                <i class="fa-solid fa-trash-can"></i>
                            </button>
                        </div>
                    </li>
                </ul>
                <div class="pagination-container">
                    <div class="prev-button">이전</div>
                    <div class="number-button-wrapper">
                        <span class="number-button">1</span></div>
                    <div class="prev-button">이후</div>
                </div>
            </div>
            <!-- con end -->
        </div>
        <!-- container end -->
    </body>

    <script>
        $(document).ready(function () {
            $.ajax({
                url: '/logListData', // 1단계에서 설정한 컨트롤러의 경로
                type: 'GET',
                dataType: 'json', // 반환되는 데이터 타입
                success: function (logs) {
                    var logListHtml = '';
                    $.each(logs, function (index, log) {
                        logListHtml += '<li><p class="index">' + (
                            index + 1
                        ) + '.</p><div class="mid"><div class="projectName">' + log.projectName + '</di' +
                                'v><span class="modelName">' + log.modelName +
                                '</span><span class="logDate">(' + log.logDate + ')</span></div><div class="del' +
                                '"><i class="fa-solid fa-trash-can"></i></div></li>';
                    });
                    $('.logList').html(logListHtml);
                },
                error: function () {
                    alert("데이터 로딩에 실패했습니다.");
                }
            });
        });

        $(document).ready(function () {
            $('.del-button').on('click', function () {
                // 삭제 버튼 내부의 data-logId 속성 값 가져옴.
                var logId = $(this).attr('data-logId');
                // closest:이 버튼을 포함하고 있는 최상위 요소를 찾는 메소드closest
                var logItem = $(this).closest('li');

                $.ajax({
                    url: '/logList/' + logId,
                    type: 'DELETE',
                    success: function (response) {
                        // AJAX 요청이 성공하면, UI에서도 해당 로그 항목을 삭제
                        logItem.remove();

                        // 로그 목록의 인덱스를 업데이트 
                        $('.logList li').each(function (index) {
                            $(this)
                                .find('.index')
                                .text(index + 1 + '.');
                        });
                    },
                    error: function () {
                        alert('로그 삭제 실패');
                    }
                });
            });
        });

        // 버튼에 이벤트 리스너를 다시 바인딩하는 함수
        function bindDeleteButtons() {
            $('.del-button')
                .off('click')
                .on('click', function () {
                    var logId = $(this).data('logId');
                    $.ajax({
                        url: '/logList/' + logId,
                        type: 'DELETE',
                        success: function (response) {
                            // 생략: 성공 시 로그 목록 업데이트 로직
                        },
                        error: function () {
                            alert('로그 삭제 실패');
                        }
                    });
                });
        }

        // 페이지 로드 시 초기 바인딩
        bindDeleteButtons();
    </script>

</html>